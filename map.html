<!doctype html>
<html>
<head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <title>Add Map</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css"
          type="text/css">
    <style>
        .map {
            height: 400px;
            width: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <script>
        let map;
        let resp = 0;
        let errs = 0;
        const coordsSet = new Set();
        let feature;

        function watchMyLocation() {
            navigator.geolocation.watchPosition((p) => {
                console.log('getCurrentPosition', p);
                resp++;
                if (resp % 20 === 0) {
                    let utterance = new SpeechSynthesisUtterance("" + resp);
                    utterance.volume = 1;
                    speechSynthesis.speak(utterance);
                }
                coordsSet.add(`lat=${p.coords.latitude} lng=${p.coords.longitude}`);
                document.getElementById('txt').innerText = `responses=${resp} unique=${coordsSet.size} errs=${errs}`;
                if (!feature) {
                    feature = new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.fromLonLat([p.coords.longitude, p.coords.latitude]))
                    });
                    var layer = new ol.layer.Vector({
                        source: new ol.source.Vector({
                            features: [feature]
                        })
                    });
                    map.addLayer(layer);
                } else {
                    feature.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([p.coords.longitude, p.coords.latitude])));
                }
                map.getView().setCenter(ol.proj.fromLonLat([p.coords.longitude, p.coords.latitude]));
                //setTimeout(() => feature.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([p.coords.longitude + 0.001, p.coords.latitude]))), 2000);
            }, (e) => {
                errs++;
                console.log('getCurrentPosition error', e);
            }, {
                enableHighAccuracy: true,
                maximumAge: 5,
                //maximumAge: old ? Infinity : 0
            });
        }
    </script>
</head>
<body>
<button onclick="watchMyLocation()">Watch my location</button>
<h3 id="txt">My openlayers Maps - talking</h3>
<div id="map" class="map"></div>
<script type="text/javascript">
    //const rusov = {lat: 50.3880789, lng: 30.6269396};
    const rusov = [30.6269396, 50.3880789];
    map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat(rusov),
            zoom: 18
        })
    });
</script>
</body>
</html>
