<!doctype html>
<html>
<head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <title>Quest</title>
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-database.js"></script>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css"
          type="text/css">
    <script>
        let deviceId = localStorage.getItem("deviceId");
        if (!deviceId) {
            deviceId = Math.round(100000 * Math.random()).toString();
            localStorage.setItem("deviceId", deviceId);
        }
        var firebaseConfig = {
            apiKey: "AIzaSyBzdDMv71fEwZzAZW6ATevAT9TWMbRveZg",
            authDomain: "app1-cfe36.firebaseapp.com",
            databaseURL: "https://app1-cfe36-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "app1-cfe36",
            storageBucket: "app1-cfe36.appspot.com",
            messagingSenderId: "1062099327891",
            appId: "1:1062099327891:web:582571408d3e4ed463a666"
        };
        firebase.initializeApp(firebaseConfig);

        function writeToDatabase(coords) {
            let newVar = {
                //...coords, - this doesn't work strangely
                t: Date.now(),
                tStr: new Date().toISOString(),
            };
            for (let key in coords) {
                if (typeof (coords[key]) === 'number') {
                    newVar[key] = coords[key];
                }
            }
            console.log('writeToDatabase', deviceId, newVar);
            firebase.database().ref("quest/" + deviceId).set(newVar);
        }

        function readFromDatabaseOn() {
            firebase.database().ref("quest").on("value", (snapshot) => {
                console.log("snapshot", Object.keys(snapshot.val()).length, snapshot.val());
            });
        }

        readFromDatabaseOn();
    </script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        .box {
            display: flex;
            flex-flow: column;
            height: 100%;
        }

        .box .row {
            border: 1px dotted grey;
        }

        .box .row.header {
            margin-left: auto;
            margin-right: 0;
            z-index: 1;
            flex: 0 1 auto;
            /* The above is shorthand for:
            flex-grow: 0,
            flex-shrink: 1,
            flex-basis: auto
            */
        }

        .box .row.content {
            position: fixed;
            flex: 1 1 auto;
        }

        /*.box .row.footer {*/
        /*    flex: 0 1 40px;*/
        /*}*/
        .map {
            /* height: 400 px; */
            height: 100%;
            width: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <script>
        let map;
        let resp = 0;
        let errs = 0;
        const coordsSet = new Set();
        let feature;
        let lastCoordsAsString = '';

        function watchMyLocation() {
            navigator.geolocation.watchPosition((p) => {
                console.log('getCurrentPosition', p);
                resp++;
                if (resp % 20 === 0) {
                    let utterance = new SpeechSynthesisUtterance("" + resp);
                    utterance.volume = 1;
                    speechSynthesis.speak(utterance);
                }
                let coordsAsString = `lat=${p.coords.latitude} lng=${p.coords.longitude}`;
                if (lastCoordsAsString !== coordsAsString) {
                    writeToDatabase(p.coords);
                    lastCoordsAsString = coordsAsString;
                }
                coordsSet.add(coordsAsString);
                document.getElementById('txt').innerText = `responses=${resp} unique=${coordsSet.size} errs=${errs}`;
                if (!feature) {
                    feature = new ol.Feature(new ol.geom.Circle(ol.proj.fromLonLat([p.coords.longitude, p.coords.latitude]), 50));
                    feature.setStyle(new ol.style.Style({
                        stroke: new ol.style.Stroke({color: '#000'}),
                        fill: new ol.style.Fill({
                            color: [150, 150, 255, 1]
                        })
                    }));
                    // feature = new ol.Feature({
                    //     geometry: new ol.geom.Point(ol.proj.fromLonLat([p.coords.longitude, p.coords.latitude]))
                    // });
                    var layer = new ol.layer.Vector({
                        source: new ol.source.Vector({
                            features: [feature]
                        })
                    });
                    map.addLayer(layer);
                } else {
                    //feature.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([p.coords.longitude, p.coords.latitude])));
                    feature.setGeometry(new ol.Feature(new ol.geom.Circle(ol.proj.fromLonLat([p.coords.longitude, p.coords.latitude]), 50)));
                }
                map.getView().setCenter(ol.proj.fromLonLat([p.coords.longitude, p.coords.latitude]));
                //setTimeout(() => feature.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([p.coords.longitude + 0.001, p.coords.latitude]))), 2000);
            }, (e) => {
                errs++;
                console.log('getCurrentPosition error', e);
            }, {
                enableHighAccuracy: true,
                maximumAge: 5,
                //maximumAge: old ? Infinity : 0
            });
        }
    </script>
</head>
<body>
<div class="box">
    <div class="row header">
        <button onclick="watchMyLocation()">Watch my location</button>
        <h3 id="txt">My openlayers Maps - talking</h3>
    </div>
    <div id="map" class="row content map"></div>
</div>
<script type="text/javascript">
    //const rusov = {lat: 50.3880789, lng: 30.6269396};
    const rusov = [30.6269396, 50.3880789];
    map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat(rusov),
            zoom: 17
        })
    });
</script>
</body>
</html>
